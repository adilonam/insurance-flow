// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider      = "prisma-client-js"
  seed          = "prisma/seed.ts"
  output        = "../src/generated/prisma"
  binaryTargets = ["native", "rhel-openssl-3.0.x", "linux-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum CaseStatus {
  INITIAL_ASSESSMENT
  ACCIDENT_IMAGES
  CLIENT_ID_PROOF_OF_ADDRESS
  CLIENT_VEHICLE_DOCUMENTS
  AUTHORISATION_MITIGATION_STATEMENT
  ISAGI_CHECK
  THREE_MONTHS_BANK_STATEMENTS
  ASKMID_SEARCH
  DVLA_LICENCE_CHECK
  HIRE_VEHICLE_DOCUMENTS
  HSR_AGREEMENTS
  PERMISSION_LETTER
  STRIPE_DETAILS
  DAMAGE_CHECKLIST
  CLIENT_QUESTIONNAIRES
  OFFBOARDING
  BHR_REPORT
  CANFORD_LAW_SETUP
  NON_CO_OPERATIVE_CLIENT
}

enum CasePriority {
  LOW
  MEDIUM
  HIGH
}

enum Role {
  USER
  PARTNER
  ADMIN
}



// NextAuth.js Models
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?   // For credentials provider
  role          Role      @default(USER)
  partnerId     String?
  partner       Partner?  @relation(fields: [partnerId], references: [id], onDelete: SetNull)
  accounts      Account[]
  sessions      Session[]
  assignedCases Case[]    @relation("CaseAssignedTo")
  createdCases  Case[]    @relation("CaseCreatedBy")
  claims        Claim[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token        String? @db.Text
  session_state   String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Case Model
model Case {
  id         String       @id @default(cuid())
  caseId     String       @unique // Format: C-1, C-2, etc.
  title      String
  client     String
  status     CaseStatus   @default(INITIAL_ASSESSMENT)
  priority   CasePriority @default(MEDIUM)
  assignedTo String?
  assignedToUser User?      @relation("CaseAssignedTo", fields: [assignedTo], references: [id], onDelete: SetNull)
  createdBy  String
  createdByUser User      @relation("CaseCreatedBy", fields: [createdBy], references: [id])
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  @@index([caseId])
  @@index([status])
  @@index([priority])
  @@index([assignedTo])
  initialAssessments InitialAssessment[]
}



model InitialAssessment {
  id                        String   @id @default(cuid())
  caseId                    String   // FK to Case
  claimReference            String?
  fullName                  String?
  address                   String?
  postCode                  String?
  dateMovedIn               DateTime?
  dateOfBirth               DateTime?
  niNumber                  String?
  dlNumber                  String?
  dlIssue                   DateTime?
  dlExpiry                  DateTime?
  claimantContactNumber     String?
  emailAddress              String?
  accidentLocation          String?
  accidentCircumstances     String?
  dateOfAccident            DateTime?
  timeOfAccident            String?
  livedInCurrentAddress3Years String?
  address2                  String?
  address2Dates             String?
  address3                  String?
  address3Dates             String?
  // Defendant Details
  defendantName             String?
  defendantReg              String?
  defendantContactNumber    String?
  defendantMakeModelColor   String?
  // Claimant Details
  claimantVehicleRegistration String?
  claimantInsurer           String?
  claimantMakeModel         String?
  mainPolicyHolder          String?
  additionalDriver1         String?
  additionalDriver2         String?
  additionalDriver3         String?
  noClaimsBonus             String?
  insuranceType             String?
  dateLicenceObtained       DateTime?
  occupation                String?
  ukResidentFromBirth       String?
  ukResidentSince           DateTime?
  vehicleValidMOTAndTax     String?
  everDeclaredBankrupt      String?
  claimantClaimingInjury    String?
  additionalInformation     String?
  accessToOtherVehicles     String?
  ownTheVehicle             String?
  vehicleOwnerRelationship  String?
  carOnFinance              String?
  workInMotorTrade          String?
  needForPrestigeVehicle    String?
  // Private Hire Driver
  privateHireLicenceYears   String?
  taxiIncomePercent         String?
  additionalEmployment      String?
  // Witness Details
  witnessName               String?
  witnessContactNumber      String?
  witnessDetailsObtained    String?
  witnessRelationToClaimant String?
  witnessAdditionalInformation String?
  // Insurance Eligibility Questions
  nonStandardDriver               Boolean?
  agedBetween25And70              Boolean?
  fullUKOrEUDrivingLicense2Years  Boolean?
  taxiLicence1Year                Boolean?
  ukResident3Years                Boolean?
  noMoreThan9PenaltyPoints        Boolean?
  notBannedFromDriving5Years      Boolean?
  noMoreThan1FaultClaim2Years     Boolean?
  noNonSpentCriminalConvictions   Boolean?
  noDisabilityOrMedicalCondition  Boolean?

  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  case                      Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([caseId])
}



model ServiceProvider {
  id        String                @id @default(cuid())
  type      ServiceProviderType
  name      String
  email     String?
  phone     String?
  address   String?
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt

  // Relations from Partner
  vehicleRecoveryPartners    Partner[] @relation("VehicleRecovery")
  vehicleStoragePartners     Partner[] @relation("VehicleStorage")
  replacementHirePartners    Partner[] @relation("ReplacementHire")
  vehicleRepairsPartners     Partner[] @relation("VehicleRepairs")
  independentEngineerPartners Partner[] @relation("IndependentEngineer")
  vehicleInspectionPartners  Partner[] @relation("VehicleInspection")
}

enum ServiceProviderType {
  INTERNAL
  EXTERNAL
}



enum PartnerType {
  DIRECT
  BROKER
  INSURER
  BODYSHOP
  DEALERSHIP
  FLEET
}

model Partner {
  id        String      @id @default(cuid())
  name      String
  email     String?
  phone     String?
  address   String?
  type      PartnerType

  // Service Provider Relations
  vehicleRecoveryId     String? @map("vehicle_recovery_id")
  vehicleRecovery       ServiceProvider? @relation("VehicleRecovery", fields: [vehicleRecoveryId], references: [id], onDelete: SetNull)

  vehicleStorageId      String? @map("vehicle_storage_id")
  vehicleStorage        ServiceProvider? @relation("VehicleStorage", fields: [vehicleStorageId], references: [id], onDelete: SetNull)

  replacementHireId     String? @map("replacement_hire_id")
  replacementHire       ServiceProvider? @relation("ReplacementHire", fields: [replacementHireId], references: [id], onDelete: SetNull)

  vehicleRepairsId      String? @map("vehicle_repairs_id")
  vehicleRepairs        ServiceProvider? @relation("VehicleRepairs", fields: [vehicleRepairsId], references: [id], onDelete: SetNull)

  independentEngineerId String? @map("independent_engineer_id")
  independentEngineer   ServiceProvider? @relation("IndependentEngineer", fields: [independentEngineerId], references: [id], onDelete: SetNull)

  vehicleInspectionId   String? @map("vehicle_inspection_id")
  vehicleInspection     ServiceProvider? @relation("VehicleInspection", fields: [vehicleInspectionId], references: [id], onDelete: SetNull)

  users     User[]
  claims    Claim[]

  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
}




enum ClaimType {
  FAULT
  NON_FAULT
}

enum ClaimStatus {
  PENDING_TRIAGE
  ACCEPTED
  REJECTED
  IN_PROGRESS_SERVICES   // Services active (e.g. hire ongoing)
  IN_PROGRESS_REPAIRS    // CIL received, repairs booked
  PENDING_OFFBOARDING    // Hire ended, collating final docs
  PENDING_OFFBOARDING_NONCOOPERATIVE // Client is unresponsive
  PAYMENT_PACK_PREPARATION // Offboarding complete, final billing
  AWAITING_FINAL_PAYMENT    // Pack sent to TPI
  CLOSED
}

// Supports document storage + nested relations for outlays and documents
model Claim {
  id               String      @id @default(cuid())
  dateOfAccident   DateTime
  type             ClaimType
  status           ClaimStatus

  clientName       String
  clientMobile     String
  clientDob        DateTime
  clientPostCode   String

  additionalDriverName   String?
  additionalDriverMobile String?
  additionalDriverDob    DateTime?
  additionalDriverPostCode String?

  tpiInsurerName   String?
  tpiInsurerContact String?

  userId           String
  user             User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  partnerId        String
  partner          Partner     @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
}












