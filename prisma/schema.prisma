// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider      = "prisma-client-js"
  seed          = "prisma/seed.ts"
  output        = "../src/generated/prisma"
  binaryTargets = ["native", "rhel-openssl-3.0.x", "linux-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
}

// Enums
enum CaseStatus {
  INITIAL_ASSESSMENT
  ACCIDENT_IMAGES
  CLIENT_ID_PROOF_OF_ADDRESS
  CLIENT_VEHICLE_DOCUMENTS
  AUTHORISATION_MITIGATION_STATEMENT
  ISAGI_CHECK
  THREE_MONTHS_BANK_STATEMENTS
  ASKMID_SEARCH
  DVLA_LICENCE_CHECK
  HIRE_VEHICLE_DOCUMENTS
  HSR_AGREEMENTS
  PERMISSION_LETTER
  STRIPE_DETAILS
  DAMAGE_CHECKLIST
  CLIENT_QUESTIONNAIRES
  OFFBOARDING
  BHR_REPORT
  CANFORD_LAW_SETUP
  NON_CO_OPERATIVE_CLIENT
}

enum CasePriority {
  LOW
  MEDIUM
  HIGH
}

enum Role {
  USER
  PARTNER
  ADMIN
}



// NextAuth.js Models
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?   // For credentials provider
  role          Role      @default(USER)
  partnerId     String?
  partner       Partner?  @relation(fields: [partnerId], references: [id], onDelete: SetNull)
  accounts      Account[]
  sessions      Session[]
  assignedCases Case[]    @relation("CaseAssignedTo")
  createdCases  Case[]    @relation("CaseCreatedBy")
  claims        Claim[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token        String? @db.Text
  session_state   String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Case Model
model Case {
  id         String       @id @default(cuid())
  caseId     String       @unique // Format: C-1, C-2, etc.
  title      String
  client     String
  status     CaseStatus   @default(INITIAL_ASSESSMENT)
  priority   CasePriority @default(MEDIUM)
  assignedTo String?
  assignedToUser User?      @relation("CaseAssignedTo", fields: [assignedTo], references: [id], onDelete: SetNull)
  createdBy  String
  createdByUser User      @relation("CaseCreatedBy", fields: [createdBy], references: [id])
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  @@index([caseId])
  @@index([status])
  @@index([priority])
  @@index([assignedTo])
  initialAssessments InitialAssessment[]
}



model InitialAssessment {
  id                        String   @id @default(cuid())
  caseId                    String   // FK to Case
  claimReference            String?
  fullName                  String?
  address                   String?
  postCode                  String?
  dateMovedIn               DateTime?
  dateOfBirth               DateTime?
  niNumber                  String?
  dlNumber                  String?
  dlIssue                   DateTime?
  dlExpiry                  DateTime?
  claimantContactNumber     String?
  emailAddress              String?
  accidentLocation          String?
  accidentCircumstances     String?
  dateOfAccident            DateTime?
  timeOfAccident            String?
  livedInCurrentAddress3Years String?
  address2                  String?
  address2Dates             String?
  address3                  String?
  address3Dates             String?
  // Defendant Details
  defendantName             String?
  defendantReg              String?
  defendantContactNumber    String?
  defendantMakeModelColor   String?
  // Claimant Details
  claimantVehicleRegistration String?
  claimantInsurer           String?
  claimantMakeModel         String?
  mainPolicyHolder          String?
  additionalDriver1         String?
  additionalDriver2         String?
  additionalDriver3         String?
  noClaimsBonus             String?
  insuranceType             String?
  dateLicenceObtained       DateTime?
  occupation                String?
  ukResidentFromBirth       String?
  ukResidentSince           DateTime?
  vehicleValidMOTAndTax     String?
  everDeclaredBankrupt      String?
  claimantClaimingInjury    String?
  additionalInformation     String?
  accessToOtherVehicles     String?
  ownTheVehicle             String?
  vehicleOwnerRelationship  String?
  carOnFinance              String?
  workInMotorTrade          String?
  needForPrestigeVehicle    String?
  // Private Hire Driver
  privateHireLicenceYears   String?
  taxiIncomePercent         String?
  additionalEmployment      String?
  // Witness Details
  witnessName               String?
  witnessContactNumber      String?
  witnessDetailsObtained    String?
  witnessRelationToClaimant String?
  witnessAdditionalInformation String?
  // Insurance Eligibility Questions
  nonStandardDriver               Boolean?
  agedBetween25And70              Boolean?
  fullUKOrEUDrivingLicense2Years  Boolean?
  taxiLicence1Year                Boolean?
  ukResident3Years                Boolean?
  noMoreThan9PenaltyPoints        Boolean?
  notBannedFromDriving5Years      Boolean?
  noMoreThan1FaultClaim2Years     Boolean?
  noNonSpentCriminalConvictions   Boolean?
  noDisabilityOrMedicalCondition  Boolean?

  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  case                      Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([caseId])
}



model ServiceProvider {
  id        String                @id @default(cuid())
  type      ServiceProviderType
  name      String
  email     String?
  phone     String?
  address   String?
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt

  // Relations from Partner
  vehicleRecoveryPartners    Partner[] @relation("VehicleRecovery")
  vehicleStoragePartners     Partner[] @relation("VehicleStorage")
  replacementHirePartners    Partner[] @relation("ReplacementHire")
  vehicleRepairsPartners     Partner[] @relation("VehicleRepairs")
  independentEngineerPartners Partner[] @relation("IndependentEngineer")
  vehicleInspectionPartners  Partner[] @relation("VehicleInspection")
}

enum ServiceProviderType {
  INTERNAL
  EXTERNAL
}



enum PartnerType {
  DIRECT
  BROKER
  INSURER
  BODYSHOP
  DEALERSHIP
  FLEET
}

model Partner {
  id        String      @id @default(cuid())
  name      String
  email     String?
  phone     String?
  address   String?
  type      PartnerType

  // Service Provider Relations
  vehicleRecoveryId     String? @map("vehicle_recovery_id")
  vehicleRecovery       ServiceProvider? @relation("VehicleRecovery", fields: [vehicleRecoveryId], references: [id], onDelete: SetNull)

  vehicleStorageId      String? @map("vehicle_storage_id")
  vehicleStorage        ServiceProvider? @relation("VehicleStorage", fields: [vehicleStorageId], references: [id], onDelete: SetNull)

  replacementHireId     String? @map("replacement_hire_id")
  replacementHire       ServiceProvider? @relation("ReplacementHire", fields: [replacementHireId], references: [id], onDelete: SetNull)

  vehicleRepairsId      String? @map("vehicle_repairs_id")
  vehicleRepairs        ServiceProvider? @relation("VehicleRepairs", fields: [vehicleRepairsId], references: [id], onDelete: SetNull)

  independentEngineerId String? @map("independent_engineer_id")
  independentEngineer   ServiceProvider? @relation("IndependentEngineer", fields: [independentEngineerId], references: [id], onDelete: SetNull)

  vehicleInspectionId   String? @map("vehicle_inspection_id")
  vehicleInspection     ServiceProvider? @relation("VehicleInspection", fields: [vehicleInspectionId], references: [id], onDelete: SetNull)

  users     User[]
  claims    Claim[]

  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  @@index([id])
}




enum ClaimType {
  FAULT
  NON_FAULT
}

enum ClaimStatus {
  PENDING_TRIAGE
  PENDING_FINANCIAL
  PENDING_LIVE_CLAIMS
  PENDING_OS_DOCS
  PENDING_PAYMENT_PACK_REVIEW
  PENDING_SENT_TO_TP
  PENDING_SENT_TO_SOLS
  PENDING_ISSUED
}

// Supports document storage + nested relations for outlays and documents
model Claim {
  id               String      @id @default(cuid())
  dateOfAccident   DateTime
  type             ClaimType
  status           ClaimStatus

  clientName       String
  clientMobile     String
  clientEmail      String?
  clientDob        DateTime
  clientPostCode   String
  vehicleRegistration String

  isPrivateHireDriver String? // "Yes", "No", or null

  accidentTime     String?
  accidentLocation String
  accidentCircumstances String @db.Text
  isVehicleDrivable String // "Yes" or "No"

  thirdPartyName   String?
  thirdPartyVehicleRegistration String?
  thirdPartyContactNumber String?

  userId           String
  user             User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  partnerId        String?
  partner          Partner?    @relation(fields: [partnerId], references: [id], onDelete: SetNull)

  uploadedFileKey  String?      // S3 key for uploaded spreadsheet
  uploadedFileName String?     // Original filename of uploaded file

  financialStep   FinancialStep?

  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
}

// Financial Step - One-to-one with Claim
model FinancialStep {
  id        String   @id @default(cuid())
  claimId   String   @unique
  claim     Claim    @relation(fields: [claimId], references: [id], onDelete: Cascade)

  bankAccounts BankAccount[]
  creditCards CreditCard[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Bank Account - Many-to-one with FinancialStep
model BankAccount {
  id                String         @id @default(cuid())
  financialStepId    String
  financialStep     FinancialStep  @relation(fields: [financialStepId], references: [id], onDelete: Cascade)

  bankName          String?
  accountNumber     String?
  accountType       String?
  last4             String?        // Last 4 digits of account
  balance           Decimal?       @db.Decimal(10, 2)
  overdraftLimit    Decimal?       @db.Decimal(10, 2) // O/D Limit
  overdraftUsed     Decimal?       @db.Decimal(10, 2)
  status            String?

  bankStatements    BankStatement[]

  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  @@index([financialStepId])
}

// Bank Statement - Many-to-one with BankAccount
model BankStatement {
  id            String       @id @default(cuid())
  bankAccountId String
  bankAccount   BankAccount  @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)

  startDate     DateTime     // Statement start date
  endDate       DateTime     // Statement end date
  fileKey       String?      // S3 key for uploaded statement (claims/financial/...)
  fileName      String?      // Original filename
  uploadedAt    DateTime?    // When the statement was uploaded

  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([bankAccountId])
}

// Credit Card - Many-to-one with FinancialStep
model CreditCard {
  id                String         @id @default(cuid())
  financialStepId    String
  financialStep     FinancialStep  @relation(fields: [financialStepId], references: [id], onDelete: Cascade)

  issuer            String?        // Card issuer (e.g., Visa, Mastercard, Store name)
  last4             String?        // Last 4 digits of card
  balance           Decimal?       @db.Decimal(10, 2)
  limit             Decimal?       @db.Decimal(10, 2) // Credit limit
  status            String?        // Active, Delinquent, Settled

  cardStatements    CardStatement[]

  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  @@index([financialStepId])
}

// Card Statement - Many-to-one with CreditCard
model CardStatement {
  id            String       @id @default(cuid())
  creditCardId String
  creditCard   CreditCard  @relation(fields: [creditCardId], references: [id], onDelete: Cascade)

  startDate     DateTime     // Statement start date
  endDate       DateTime     // Statement end date
  fileKey       String?      // S3 key for uploaded statement (claims/financial/...)
  fileName      String?      // Original filename
  uploadedAt    DateTime?    // When the statement was uploaded

  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([creditCardId])
}












